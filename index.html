<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Best of US Investors International Heatmap</title>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background-color: #131722;
      color: #d1d4dc;
      min-height: 100vh;
    }

    .header {
      background: #1e222d;
      padding: 12px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 10px;
      border-bottom: 1px solid #2a2e39;
    }

    .header h1 {
      font-size: 1.3rem;
      font-weight: 600;
      color: #fff;
    }

    .header-subtitle {
      font-size: 0.8rem;
      color: #787b86;
      margin-left: 10px;
    }

    .header-controls {
      display: flex;
      gap: 8px;
      align-items: center;
      flex-wrap: wrap;
    }

    .header select, .header button {
      background: #2a2e39;
      color: #d1d4dc;
      border: 1px solid #363a45;
      padding: 6px 10px;
      border-radius: 4px;
      font-size: 0.85rem;
      cursor: pointer;
    }

    .header select:hover, .header button:hover {
      background: #363a45;
    }

    .header button.refresh {
      background: #2962ff;
      border-color: #2962ff;
      color: #fff;
    }

    .header button.refresh:hover {
      background: #1e4bd8;
    }

    .status {
      font-size: 0.75rem;
      color: #787b86;
    }

    .main-container {
      display: flex;
      flex-direction: column;
      height: calc(100vh - 60px);
      padding: 10px 30px;
    }

    #treemap {
      flex: 1;
      padding: 8px;
      overflow: hidden;
      background: #131722;
    }

    .cell {
      cursor: pointer;
      transition: opacity 0.15s;
    }

    .cell:hover {
      opacity: 0.8;
    }

    .cell rect {
      stroke: #1e222d;
      stroke-width: 1.5px;
    }

    .tooltip {
      position: fixed;
      background: #1e222d;
      border: 1px solid #363a45;
      border-radius: 8px;
      padding: 12px 16px;
      font-size: 0.85rem;
      pointer-events: none;
      z-index: 1000;
      box-shadow: 0 4px 20px rgba(0,0,0,0.5);
      max-width: 320px;
    }

    .tooltip-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
      padding-bottom: 8px;
      border-bottom: 1px solid #363a45;
    }

    .tooltip-ticker {
      font-size: 1.1rem;
      font-weight: 700;
      color: #fff;
    }

    .tooltip-change {
      font-size: 1rem;
      font-weight: 600;
    }

    .tooltip-name {
      color: #787b86;
      margin-bottom: 8px;
      font-size: 0.8rem;
    }

    .tooltip-section {
      background: #2a2e39;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 0.7rem;
      margin-bottom: 8px;
      display: inline-block;
    }

    .tooltip-row {
      display: flex;
      justify-content: space-between;
      margin: 4px 0;
    }

    .tooltip-label {
      color: #787b86;
    }

    .tooltip-value {
      color: #d1d4dc;
      font-weight: 500;
    }

    .tooltip-perf-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 6px;
      margin-top: 10px;
      padding-top: 10px;
      border-top: 1px solid #363a45;
    }

    .tooltip-perf-item {
      text-align: center;
      padding: 4px;
      border-radius: 4px;
      background: #2a2e39;
    }

    .tooltip-perf-label {
      font-size: 0.65rem;
      color: #787b86;
      margin-bottom: 2px;
    }

    .tooltip-perf-value {
      font-size: 0.8rem;
      font-weight: 600;
    }

    .legend {
      background: #1e222d;
      padding: 8px 20px;
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 4px;
      border-top: 1px solid #2a2e39;
      flex-wrap: wrap;
    }

    .legend-item {
      width: 36px;
      height: 22px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.65rem;
      font-weight: 600;
      border-radius: 2px;
    }

    .loading {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(19, 23, 34, 0.95);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 2000;
    }

    .loading-content {
      text-align: center;
    }

    .spinner {
      width: 50px;
      height: 50px;
      border: 4px solid #2a2e39;
      border-top-color: #2962ff;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 15px;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .hidden {
      display: none !important;
    }

    @media (max-width: 768px) {
      .header {
        padding: 8px 12px;
      }
      
      .header h1 {
        font-size: 1rem;
      }
      
      .header select, .header button {
        padding: 5px 8px;
        font-size: 0.75rem;
      }
      
      .legend-item {
        width: 30px;
        height: 18px;
        font-size: 0.55rem;
      }

      .main-container {
        padding: 5px 10px;
      }
    }

    .control-group {
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .period-indicator {
      background: #2962ff;
      color: #fff;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 0.75rem;
      font-weight: 600;
    }
  </style>
</head>
<body>
  <div class="loading" id="loading">
    <div class="loading-content">
      <div class="spinner"></div>
      <div>Loading country ETF data...</div>
    </div>
  </div>

  <header class="header">
    <div>
      <h1>üåç Best of US Investors International Heatmap</h1>
      <span class="header-subtitle">Single Country ETFs by Region</span>
    </div>
    <div class="header-controls">
      <div class="control-group">
        <select id="period" title="Performance period">
          <option value="1D">Period: Daily</option>
          <option value="1W">Period: Weekly</option>
          <option value="1M">Period: Monthly</option>
          <option value="3M">Period: Quarterly</option>
          <option value="6M">Period: 6 Month</option>
          <option value="ytd">Period: YTD</option>
          <option value="1Y">Period: 1 Year</option>
        </select>
      </div>

      <div class="control-group">
        <select id="sizeBy" title="Size boxes by">
          <option value="balanced">Size: Balanced</option>
          <option value="sqrt">Size: Square Root</option>
          <option value="equal">Size: Equal</option>
          <option value="marketcap">Size: By AUM</option>
        </select>
      </div>

      <button class="refresh" onclick="refreshData()">üîÑ Refresh</button>
      <span class="status" id="status">Loading...</span>
    </div>
  </header>

  <div class="main-container">
    <div id="treemap"></div>
  </div>

  <div class="legend" id="legend"></div>

  <div class="tooltip hidden" id="tooltip"></div>

  <script>
    const API_KEY = 'e0enTj1fVE1n8IVYZaFKj6P5nfIHYNMM';
    
    // ETF Categories - Single Country ETFs
    const PORTFOLIO = {
      "üåè Asia Pacific": {
        tickers: ["EWA", "MCHI", "EWH", "INDA", "EIDO", "EWJ", "EWY", "EWM", "ENZL", "EPHE", "EWS", "EWT", "THD", "TOK"],
        color: "#E65100"
      },
      "üá™üá∫ Europe": {
        tickers: ["EWO", "EWK", "EDEN", "EFNL", "EWQ", "EWG", "EIRL", "EWI", "EWN", "ENOR", "EPOL", "EWP", "EWD", "EWL", "EWU"],
        color: "#1565C0"
      },
      "üåé Americas": {
        tickers: ["EWZ", "EWC", "ECH", "EWW"],
        color: "#2E7D32"
      },
      "üåç Middle East & Africa": {
        tickers: ["EZA", "EIS", "KSA", "KWT", "QAT", "TUR"],
        color: "#C62828"
      }
    };

    const ALL_TICKERS = Object.values(PORTFOLIO).flatMap(p => p.tickers);

    // Dynamic color scales based on period
    const COLOR_SCALES = {
      '1D': { thresholds: [-3, -2, -1, -0.5, 0.5, 1, 2, 3], labels: ['-3%', '-2%', '-1%', '-0.5%', '0%', '+0.5%', '+1%', '+2%', '+3%'] },
      '1W': { thresholds: [-5, -3, -2, -1, 1, 2, 3, 5], labels: ['-5%', '-3%', '-2%', '-1%', '0%', '+1%', '+2%', '+3%', '+5%'] },
      '1M': { thresholds: [-10, -5, -3, -1, 1, 3, 5, 10], labels: ['-10%', '-5%', '-3%', '-1%', '0%', '+1%', '+3%', '+5%', '+10%'] },
      '3M': { thresholds: [-15, -10, -5, -2, 2, 5, 10, 15], labels: ['-15%', '-10%', '-5%', '-2%', '0%', '+2%', '+5%', '+10%', '+15%'] },
      '6M': { thresholds: [-20, -15, -10, -5, 5, 10, 15, 20], labels: ['-20%', '-15%', '-10%', '-5%', '0%', '+5%', '+10%', '+15%', '+20%'] },
      'ytd': { thresholds: [-30, -20, -10, -5, 5, 10, 20, 30], labels: ['-30%', '-20%', '-10%', '-5%', '0%', '+5%', '+10%', '+20%', '+30%'] },
      '1Y': { thresholds: [-40, -25, -15, -5, 5, 15, 25, 40], labels: ['-40%', '-25%', '-15%', '-5%', '0%', '+5%', '+15%', '+25%', '+40%'] },
      'daily': { thresholds: [-3, -2, -1, -0.5, 0.5, 1, 2, 3], labels: ['-3%', '-2%', '-1%', '-0.5%', '0%', '+0.5%', '+1%', '+2%', '+3%'] }
    };

    const BASE_COLORS = [
      '#B71C1C', '#D32F2F', '#E53935', '#EF5350', 
      '#37474F', 
      '#4DB6AC', '#26A69A', '#00E676', '#00C853'
    ];

    // State
    let stockData = [];
    let priceChangeData = {};
    let period = '1D';
    let sizeBy = 'balanced';

    // ============================================
    // API FUNCTIONS
    // ============================================
    async function fetchStockData() {
      const batchSize = 50;
      const allData = [];

      for (let i = 0; i < ALL_TICKERS.length; i += batchSize) {
        const batch = ALL_TICKERS.slice(i, i + batchSize);
        const symbols = batch.join(',');
        const url = `https://financialmodelingprep.com/api/v3/quote/${symbols}?apikey=${API_KEY}`;

        try {
          const response = await fetch(url);
          const data = await response.json();
          if (Array.isArray(data)) {
            allData.push(...data);
          }
        } catch (error) {
          console.error('Error fetching stock data:', error);
        }
        
        if (i + batchSize < ALL_TICKERS.length) {
          await new Promise(resolve => setTimeout(resolve, 300));
        }
      }

      return allData;
    }

    async function fetchPriceChangeData() {
      const batchSize = 50;
      const allData = {};

      for (let i = 0; i < ALL_TICKERS.length; i += batchSize) {
        const batch = ALL_TICKERS.slice(i, i + batchSize);
        const symbols = batch.join(',');
        const url = `https://financialmodelingprep.com/api/v3/stock-price-change/${symbols}?apikey=${API_KEY}`;

        try {
          const response = await fetch(url);
          const data = await response.json();
          if (Array.isArray(data)) {
            data.forEach(item => {
              allData[item.symbol] = item;
            });
          }
        } catch (error) {
          console.error('Error fetching price change data:', error);
        }
        
        if (i + batchSize < ALL_TICKERS.length) {
          await new Promise(resolve => setTimeout(resolve, 300));
        }
      }

      return allData;
    }

    // ============================================
    // HELPER FUNCTIONS
    // ============================================
    function getPerformanceValue(symbol, period) {
      const stock = stockData.find(s => s.symbol === symbol);
      const priceChange = priceChangeData[symbol];
      
      if (period === '1D') {
        return stock?.changesPercentage || 0;
      }
      
      if (!priceChange) return 0;
      
      // Map our period names to FMP API field names
      const periodMap = {
        '1W': '5D',   // FMP uses 5D for weekly
        '1M': '1M',
        '3M': '3M',
        '6M': '6M',
        'ytd': 'ytd',
        '1Y': '1Y'
      };
      
      return priceChange[periodMap[period]] || 0;
    }

    function getColorValue(symbol) {
      return getPerformanceValue(symbol, period);
    }

    function getColorScale() {
      return COLOR_SCALES[period] || COLOR_SCALES['1D'];
    }

    function getColor(value) {
      const scale = getColorScale();
      const thresholds = scale.thresholds;
      
      for (let i = 0; i < thresholds.length; i++) {
        if (value < thresholds[i]) {
          return BASE_COLORS[i];
        }
      }
      return BASE_COLORS[BASE_COLORS.length - 1];
    }

    function getTextColor(bgColor) {
      const hex = bgColor.replace('#', '');
      const r = parseInt(hex.substr(0, 2), 16);
      const g = parseInt(hex.substr(2, 2), 16);
      const b = parseInt(hex.substr(4, 2), 16);
      const luminance = (0.299 * r + 0.587 * g + 0.114 * b) / 255;
      return luminance > 0.5 ? '#000000' : '#FFFFFF';
    }

    function getSizeValue(stock) {
      const marketCap = stock.marketCap || 1000000;
      
      switch (sizeBy) {
        case 'equal':
          return 1;
        
        case 'balanced':
          const allCaps = stockData.map(s => s.marketCap || 1000000);
          const minCap = Math.min(...allCaps);
          const maxCap = Math.max(...allCaps);
          const logVal = Math.log10(marketCap);
          const logMin = Math.log10(minCap);
          const logMax = Math.log10(maxCap);
          const normalized = (logVal - logMin) / (logMax - logMin);
          return 1 + (normalized * 3);
        
        case 'sqrt':
          // Square root - moderate compression, large caps ~10-20x bigger than small
          const allCapsSqrt = stockData.map(s => s.marketCap || 1000000);
          const minCapSqrt = Math.min(...allCapsSqrt);
          const maxCapSqrt = Math.max(...allCapsSqrt);
          const sqrtVal = Math.sqrt(marketCap);
          const sqrtMin = Math.sqrt(minCapSqrt);
          const sqrtMax = Math.sqrt(maxCapSqrt);
          const sqrtNormalized = (sqrtVal - sqrtMin) / (sqrtMax - sqrtMin);
          return 1 + (sqrtNormalized * 8);
        
        case 'marketcap':
        default:
          return marketCap;
      }
    }

    // ============================================
    // DATA PROCESSING
    // ============================================
    function buildHierarchy() {
      const dataMap = {};
      stockData.forEach(s => { dataMap[s.symbol] = s; });

      const children = [];
      
      for (const [sectionName, section] of Object.entries(PORTFOLIO)) {
        const stocks = section.tickers
          .map(t => dataMap[t])
          .filter(s => s)
          .map(s => ({
            name: s.symbol,
            value: getSizeValue(s),
            data: s,
            section: sectionName,
            sectionColor: section.color,
            sortValue: getPerformanceValue(s.symbol, period)
          }));

        if (stocks.length > 0) {
          // Sort by performance within each category (best to worst)
          stocks.sort((a, b) => b.sortValue - a.sortValue);
          
          children.push({
            name: sectionName,
            children: stocks,
            sectionColor: section.color,
            avgPerformance: stocks.reduce((sum, s) => sum + s.sortValue, 0) / stocks.length
          });
        }
      }

      // Sort sections by average performance
      children.sort((a, b) => b.avgPerformance - a.avgPerformance);

      return { name: 'root', children };
    }

    // ============================================
    // RENDERING
    // ============================================
    function renderTreemap() {
      const container = document.getElementById('treemap');
      container.innerHTML = '';

      const width = container.clientWidth;
      const height = container.clientHeight;

      const hierarchy = buildHierarchy();

      const root = d3.hierarchy(hierarchy)
        .sum(d => d.value)
        .sort((a, b) => b.value - a.value);

      const treemap = d3.treemap()
        .size([width, height])
        .paddingTop(24)
        .paddingRight(3)
        .paddingBottom(3)
        .paddingLeft(3)
        .paddingInner(3)
        .round(true);

      treemap(root);

      const svg = d3.select('#treemap')
        .append('svg')
        .attr('width', width)
        .attr('height', height);

      // Draw section backgrounds and labels
      const sections = root.children || [];
      sections.forEach(section => {
        const sectionColor = section.data.sectionColor || '#2a2e39';
        const avgPerf = section.data.avgPerformance || 0;
        const perfText = (avgPerf >= 0 ? '+' : '') + avgPerf.toFixed(1) + '%';
        
        svg.append('rect')
          .attr('x', section.x0)
          .attr('y', section.y0)
          .attr('width', section.x1 - section.x0)
          .attr('height', section.y1 - section.y0)
          .attr('fill', 'none')
          .attr('stroke', sectionColor)
          .attr('stroke-width', 2);

        svg.append('rect')
          .attr('x', section.x0)
          .attr('y', section.y0)
          .attr('width', section.x1 - section.x0)
          .attr('height', 22)
          .attr('fill', sectionColor);

        const availableWidth = section.x1 - section.x0 - 50;
        let labelText = section.data.name;
        if (labelText.length > availableWidth / 7) {
          labelText = labelText.substring(0, Math.floor(availableWidth / 7)) + '...';
        }
        
        svg.append('text')
          .attr('x', section.x0 + 6)
          .attr('y', section.y0 + 15)
          .attr('font-size', '11px')
          .attr('font-weight', '700')
          .attr('fill', '#FFFFFF')
          .text(labelText);

        // Add average performance to header
        if (section.x1 - section.x0 > 80) {
          svg.append('text')
            .attr('x', section.x1 - 6)
            .attr('y', section.y0 + 15)
            .attr('font-size', '10px')
            .attr('font-weight', '600')
            .attr('fill', avgPerf >= 0 ? '#A5D6A7' : '#EF9A9A')
            .attr('text-anchor', 'end')
            .text(perfText);
        }
      });

      // Draw ETF cells
      const leaves = root.leaves();

      const cells = svg.selectAll('.cell')
        .data(leaves)
        .enter()
        .append('g')
        .attr('class', 'cell')
        .attr('transform', d => `translate(${d.x0},${d.y0})`);

      cells.append('rect')
        .attr('width', d => Math.max(0, d.x1 - d.x0))
        .attr('height', d => Math.max(0, d.y1 - d.y0))
        .attr('fill', d => {
          const value = getColorValue(d.data.name);
          return getColor(value);
        })
        .attr('rx', 2);

      // Add text
      cells.each(function(d) {
        const cellWidth = d.x1 - d.x0;
        const cellHeight = d.y1 - d.y0;
        const cell = d3.select(this);

        const displayValue = getColorValue(d.data.name);
        const bgColor = getColor(displayValue);
        const textColor = getTextColor(bgColor);

        if (cellWidth < 30 || cellHeight < 24) return;

        const tickerSize = Math.min(
          Math.max(8, Math.floor(cellWidth / 5)),
          Math.max(8, Math.floor(cellHeight / 2.8)),
          13
        );

        cell.append('text')
          .attr('x', cellWidth / 2)
          .attr('y', cellHeight / 2 - (cellHeight > 42 ? 6 : 1))
          .attr('text-anchor', 'middle')
          .attr('dominant-baseline', 'middle')
          .attr('font-size', `${tickerSize}px`)
          .attr('font-weight', '700')
          .attr('fill', textColor)
          .text(d.data.name);

        if (cellHeight > 42 && cellWidth > 38) {
          const pctText = (displayValue >= 0 ? '+' : '') + displayValue.toFixed(2) + '%';
          const pctSize = Math.min(tickerSize - 1, 10);
          
          cell.append('text')
            .attr('x', cellWidth / 2)
            .attr('y', cellHeight / 2 + tickerSize / 2 + 5)
            .attr('text-anchor', 'middle')
            .attr('dominant-baseline', 'middle')
            .attr('font-size', `${pctSize}px`)
            .attr('font-weight', '600')
            .attr('fill', textColor)
            .text(pctText);
        }
      });

      cells
        .on('mouseenter', showTooltip)
        .on('mousemove', moveTooltip)
        .on('mouseleave', hideTooltip);
    }

    // ============================================
    // TOOLTIP
    // ============================================
    function showTooltip(event, d) {
      const tooltip = document.getElementById('tooltip');
      const stock = d.data.data;
      const section = d.data.section;
      const symbol = d.data.name;

      if (!stock) return;

      const daily = getPerformanceValue(symbol, '1D');
      const weekly = getPerformanceValue(symbol, '1W');
      const monthly = getPerformanceValue(symbol, '1M');
      const quarterly = getPerformanceValue(symbol, '3M');
      const sixMonth = getPerformanceValue(symbol, '6M');
      const ytd = getPerformanceValue(symbol, 'ytd');
      const yearly = getPerformanceValue(symbol, '1Y');

      const formatPerf = (val) => {
        const color = val >= 0 ? '#00C853' : '#EF5350';
        return `<span style="color: ${color}">${val >= 0 ? '+' : ''}${val.toFixed(2)}%</span>`;
      };

      tooltip.innerHTML = `
        <div class="tooltip-header">
          <span class="tooltip-ticker">${stock.symbol}</span>
          <span class="tooltip-change" style="color: ${daily >= 0 ? '#00C853' : '#EF5350'}">
            ${daily >= 0 ? '+' : ''}${daily.toFixed(2)}%
          </span>
        </div>
        <span class="tooltip-section" style="background: ${d.data.sectionColor}">${section}</span>
        <div class="tooltip-name">${stock.name || ''}</div>
        <div class="tooltip-row">
          <span class="tooltip-label">Price</span>
          <span class="tooltip-value">$${(stock.price || 0).toFixed(2)}</span>
        </div>
        <div class="tooltip-row">
          <span class="tooltip-label">Volume</span>
          <span class="tooltip-value">${formatNumber(stock.volume)}</span>
        </div>
        <div class="tooltip-perf-grid">
          <div class="tooltip-perf-item">
            <div class="tooltip-perf-label">1D</div>
            <div class="tooltip-perf-value">${formatPerf(daily)}</div>
          </div>
          <div class="tooltip-perf-item">
            <div class="tooltip-perf-label">1W</div>
            <div class="tooltip-perf-value">${formatPerf(weekly)}</div>
          </div>
          <div class="tooltip-perf-item">
            <div class="tooltip-perf-label">1M</div>
            <div class="tooltip-perf-value">${formatPerf(monthly)}</div>
          </div>
          <div class="tooltip-perf-item">
            <div class="tooltip-perf-label">3M</div>
            <div class="tooltip-perf-value">${formatPerf(quarterly)}</div>
          </div>
          <div class="tooltip-perf-item">
            <div class="tooltip-perf-label">6M</div>
            <div class="tooltip-perf-value">${formatPerf(sixMonth)}</div>
          </div>
          <div class="tooltip-perf-item">
            <div class="tooltip-perf-label">YTD</div>
            <div class="tooltip-perf-value">${formatPerf(ytd)}</div>
          </div>
          <div class="tooltip-perf-item">
            <div class="tooltip-perf-label">1Y</div>
            <div class="tooltip-perf-value">${formatPerf(yearly)}</div>
          </div>
        </div>
      `;

      tooltip.classList.remove('hidden');
      moveTooltip(event);
    }

    function moveTooltip(event) {
      const tooltip = document.getElementById('tooltip');
      const padding = 15;
      let x = event.clientX + padding;
      let y = event.clientY + padding;

      const rect = tooltip.getBoundingClientRect();
      if (x + rect.width > window.innerWidth) {
        x = event.clientX - rect.width - padding;
      }
      if (y + rect.height > window.innerHeight) {
        y = event.clientY - rect.height - padding;
      }

      tooltip.style.left = `${x}px`;
      tooltip.style.top = `${y}px`;
    }

    function hideTooltip() {
      document.getElementById('tooltip').classList.add('hidden');
    }

    // ============================================
    // LEGEND
    // ============================================
    function renderLegend() {
      const legend = document.getElementById('legend');
      const scale = getColorScale();
      
      const periodLabels = {
        '1D': 'Daily', '1W': 'Weekly', '1M': 'Monthly', 
        '3M': 'Quarterly', '6M': '6 Month', 'ytd': 'YTD', '1Y': '1 Year'
      };

      legend.innerHTML = `
        <span class="period-indicator">${periodLabels[period]} Performance</span>
        ${BASE_COLORS.map((c, i) => `
          <div class="legend-item" style="background: ${c}; color: ${getTextColor(c)}">
            ${scale.labels[i]}
          </div>
        `).join('')}
      `;
    }

    // ============================================
    // UTILITIES
    // ============================================
    function formatNumber(num) {
      if (!num) return '0';
      if (num >= 1e9) return (num / 1e9).toFixed(2) + 'B';
      if (num >= 1e6) return (num / 1e6).toFixed(2) + 'M';
      if (num >= 1e3) return (num / 1e3).toFixed(2) + 'K';
      return num.toFixed(0);
    }

    function updateStatus(text) {
      document.getElementById('status').textContent = text;
    }

    // ============================================
    // EVENT HANDLERS
    // ============================================
    async function refreshData() {
      document.getElementById('loading').classList.remove('hidden');
      updateStatus('Refreshing...');

      try {
        stockData = await fetchStockData();
        priceChangeData = await fetchPriceChangeData();
        renderTreemap();
        renderLegend();
        updateStatus(`Updated: ${new Date().toLocaleTimeString()} | ${stockData.length} ETFs`);
      } catch (error) {
        updateStatus('Error loading data');
        console.error(error);
      }

      document.getElementById('loading').classList.add('hidden');
    }

    function setupEventListeners() {
      document.getElementById('period').addEventListener('change', (e) => {
        period = e.target.value;
        renderTreemap();
        renderLegend();
      });

      document.getElementById('sizeBy').addEventListener('change', (e) => {
        sizeBy = e.target.value;
        renderTreemap();
      });

      let resizeTimeout;
      window.addEventListener('resize', () => {
        clearTimeout(resizeTimeout);
        resizeTimeout = setTimeout(renderTreemap, 250);
      });
    }

    // ============================================
    // INITIALIZATION
    // ============================================
    async function init() {
      setupEventListeners();
      await refreshData();
      setInterval(refreshData, 5 * 60 * 1000);
    }

    init();
  </script>
</body>
</html>
